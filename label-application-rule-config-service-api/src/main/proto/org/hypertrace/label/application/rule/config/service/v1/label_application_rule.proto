syntax = "proto3";

package org.hypertrace.label.application.rule.config.service.v1;

option java_multiple_files = true;

message LabelApplicationRule {
  string id = 1;
  LabelApplicationRuleData data = 2;
}

message LabelApplicationRuleData {
  string name = 1;
  MatchingCriteria matching_criteria = 2;
  ApplicationCriteria application_criteria = 3;

  message MatchingCriteria {
    Type type = 1;
    repeated Condition conditions = 2;

    enum Type {
      TYPE_UNSPECIFIED = 0;
      TYPE_SPAN = 1;
      TYPE_TRACE = 2;
    }

    message Condition {
      oneof condition {
        StringCondition string_condition = 1;
        UnaryCondition unary_condition = 3;
      }
    }

    message StringCondition {
      Scope scope = 1;
      string key = 2;
      Operator operator = 3;
      string value = 4;

      enum Operator {
        OPERATOR_UNSPECIFIED = 0;
        OPERATOR_EQUALS = 1; // operator to check if the key exists, and value is equal to the provided value
        OPERATOR_MATCHES_REGEX = 6; // operator to check if the key exists, and value matches the provided regex value
      }
    }

    message UnaryCondition {
      Scope scope = 1;
      string key = 2; // checks for existence of the key
    }
  }

  message ApplicationCriteria {
    Type type = 1;
    string sub_type = 2; // captures the entity type - "API", "Service"
    Action action = 3;

    enum Type {
      TYPE_UNSPECIFIED = 0;
      TYPE_ENTITY = 1;
    }

    message Action {
      Operation operation = 1;
      oneof value {
        string static_label_id = 2;
        DynamicLabel dynamic_label = 3;
      }

      enum Operation {
        OPERATION_UNSPECIFIED = 0;
        OPERATION_MERGE = 1;
      }

      message DynamicLabel {
        repeated TokenExtractionRule token_extraction_rules = 1;
        string token_combining_expression  = 2; // sample expression "${deployment}_${version}"

        message TokenExtractionRule {
          string key = 1;
          Scope scope = 2;
          optional string alias = 3;
        }
      }
    }
  }

  enum Scope {
    SCOPE_UNSPECIFIED = 0;
    SCOPE_ATTRIBUTE = 1;
    SCOPE_REQUEST = 2;
    SCOPE_RESPONSE = 3;
  }
}
